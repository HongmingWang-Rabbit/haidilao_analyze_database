#!/usr/bin/env python3
"""
Examine Material Details Sheet

This script examines the material details sheets to see the actual usage calculations
with conversion rates.
"""

import sys
import os
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent))

import pandas as pd
import logging
from openpyxl import load_workbook

# Configure logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


def examine_material_details_sheet():
    """Examine the material details sheet for usage calculations"""
    
    # Check the monthly material report
    report_file = Path("output/monthly_material_report_2025_05_31.xlsx")
    
    if not report_file.exists():
        logger.error(f"Report file not found: {report_file}")
        return False
    
    try:
        logger.info(f"Examining file: {report_file}")
        
        # Look specifically at the material details sheet for Store 1
        sheet_name = "物料明细-加拿大一店"
        
        logger.info(f"Reading sheet: {sheet_name}")
        
        # Try different approaches to read the sheet
        try:
            # Try reading with header at different rows
            df = pd.read_excel(report_file, sheet_name=sheet_name, header=None, nrows=50)
            
            logger.info(f"Sheet has {len(df)} rows and {len(df.columns)} columns")
            
            # Look for rows that contain material numbers or calculations
            logger.info("Searching for beef brisket material (1500677) or usage calculations...")
            
            for i, row in df.iterrows():
                row_str = ' '.join([str(cell) for cell in row if pd.notna(cell)])
                
                # Look for beef material or usage calculations
                if ('1500677' in row_str or 
                    '牛腩肉' in row_str or 
                    'materials_use' in row_str or 
                    ('精品肥牛' in row_str and any(str(cell).replace('.', '').isdigit() and float(str(cell)) > 100 for cell in row if pd.notna(cell)))):
                    
                    logger.info(f"Row {i+1}: {[str(cell) for cell in row if pd.notna(cell)]}")
                    
                    # Look for numerical values that might be calculations
                    numbers = []
                    for cell in row:
                        if pd.notna(cell):
                            try:
                                if isinstance(cell, (int, float)):
                                    numbers.append(float(cell))
                                elif str(cell).replace('.', '').replace('-', '').isdigit():
                                    numbers.append(float(cell))
                            except:
                                pass
                    
                    if numbers:
                        logger.info(f"  Numbers in row: {numbers}")
            
            # Also look for column headers that might indicate calculations
            logger.info("\nLooking for calculation-related headers...")
            for i, row in df.head(10).iterrows():
                row_values = [str(cell) for cell in row if pd.notna(cell)]
                row_str = ' '.join(row_values)
                
                if any(keyword in row_str for keyword in ['理论', 'theoretical', '用量', 'usage', '计算', 'calculation', '转换', 'conversion']):
                    logger.info(f"Header row {i+1}: {row_values}")
            
        except Exception as e:
            logger.error(f"Error reading sheet: {e}")
        
        # Also check if there are any detailed worksheets with the usage breakdown
        workbook = load_workbook(report_file, read_only=True)
        
        logger.info(f"\nAll sheets in workbook:")
        for sheet in workbook.sheetnames:
            logger.info(f"  - {sheet}")
        
        # Look for any sheets that might contain detailed calculations
        detail_sheets = [sheet for sheet in workbook.sheetnames if '明细' in sheet or '详细' in sheet]
        
        if detail_sheets:
            logger.info(f"\nFound detail sheets: {detail_sheets}")
            
            # Read from the first detail sheet with more targeted approach
            detail_sheet = detail_sheets[0]
            logger.info(f"\nExamining detail sheet: {detail_sheet}")
            
            try:
                # Read the sheet and look for the specific data we want
                df_detail = pd.read_excel(report_file, sheet_name=detail_sheet, header=None)
                
                # Search for rows containing dish names and numerical calculations
                for i, row in df_detail.iterrows():
                    row_values = [str(cell) for cell in row if pd.notna(cell)]
                    row_str = ' '.join(row_values)
                    
                    # Look for dish names with calculations
                    if ('精品肥牛' in row_str or '番茄火锅' in row_str) and len([x for x in row_values if x.replace('.', '').replace('-', '').isdigit()]) > 3:
                        logger.info(f"Detail row {i+1}: {row_values}")
                        
                        # Extract numerical values
                        numbers = []
                        for val in row_values:
                            try:
                                if val.replace('.', '').replace('-', '').isdigit():
                                    numbers.append(float(val))
                            except:
                                pass
                        
                        if len(numbers) >= 4:  # Likely has sale amount, standard_quantity, loss_rate, conversion_rate, materials_use
                            logger.info(f"  Numbers: {numbers}")
                            
                            # Try to identify which calculation is being used
                            if len(numbers) >= 5:
                                sale_amount = numbers[0]
                                standard_qty = numbers[1] if numbers[1] < 10 else numbers[2]  # Standard quantity usually < 10
                                loss_rate = numbers[2] if numbers[2] > 1 and numbers[2] < 2 else numbers[3]
                                conversion_rate = numbers[3] if numbers[3] != 1.0 else numbers[4] if len(numbers) > 4 else 1.0
                                materials_use = numbers[-1]  # Usually the last number
                                
                                # Test both multiplication and division
                                calc_multiply = sale_amount * standard_qty * loss_rate * conversion_rate
                                calc_divide = sale_amount * standard_qty * loss_rate / conversion_rate
                                
                                logger.info(f"  Testing calculations:")
                                logger.info(f"    Sale: {sale_amount}, Std: {standard_qty}, Loss: {loss_rate}, Conv: {conversion_rate}")
                                logger.info(f"    materials_use (actual): {materials_use}")
                                logger.info(f"    Multiply result: {calc_multiply:.4f}")
                                logger.info(f"    Divide result: {calc_divide:.4f}")
                                
                                if abs(calc_multiply - materials_use) < abs(calc_divide - materials_use):
                                    logger.info(f"    ✅ MULTIPLICATION is closer to actual")
                                else:
                                    logger.info(f"    ✅ DIVISION is closer to actual")
                
            except Exception as e:
                logger.warning(f"Could not read detail sheet: {e}")
        
        workbook.close()
        
    except Exception as e:
        logger.error(f"Error examining material details: {e}")
        import traceback
        traceback.print_exc()
        return False
    
    return True


if __name__ == "__main__":
    success = examine_material_details_sheet()
    if success:
        print("Material details examination completed!")
    else:
        print("Material details examination failed!")