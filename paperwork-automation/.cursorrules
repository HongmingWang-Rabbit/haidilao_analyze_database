# Haidilao Paperwork Automation System - Cursor Rules

# ===================================================

# This file defines coding standards, project structure, and automated update requirements

# for the Haidilao restaurant data processing and report generation system.

## ğŸ¯ PROJECT OVERVIEW

This is a production-grade automation system for processing Haidilao restaurant Excel data
and generating comprehensive database reports with 4 worksheets:

- å¯¹æ¯”ä¸Šæœˆè¡¨ (Monthly Comparison)
- åŒæ¯”æ•°æ® (Yearly Comparison)
- åˆ†æ—¶æ®µ-ä¸ŠæŠ¥ (Time Segment Report)
- è¥ä¸šé€è§† (Business Insight)

## ğŸ“ PROJECT STRUCTURE

```
paperwork-automation/
â”œâ”€â”€ scripts/                    # Entry points and CLI tools
â”‚   â”œâ”€â”€ automation-menu.py     # Interactive main menu (MUST UPDATE)
â”‚   â”œâ”€â”€ automation-gui.py      # Modern GUI interface (MUST UPDATE)
â”‚   â”œâ”€â”€ extract-all.py         # Data extraction orchestrator
â”‚   â”œâ”€â”€ extract-dishes.py      # Dish extraction with size handling
â”‚   â”œâ”€â”€ extract-materials.py   # Material extraction from exports
â”‚   â”œâ”€â”€ extract-dish-materials.py # Dish-material relationship extraction
â”‚   â”œâ”€â”€ extract_dish_price_history.py # Price history extraction
â”‚   â””â”€â”€ generate_database_report.py # Report generation
â”œâ”€â”€ launch-gui.py              # GUI launcher script
â”œâ”€â”€ lib/                       # Core business logic
â”‚   â”œâ”€â”€ comparison_worksheet.py
â”‚   â”œâ”€â”€ yearly_comparison_worksheet.py
â”‚   â”œâ”€â”€ time_segment_worksheet.py
â”‚   â”œâ”€â”€ business_insight_worksheet.py
â”‚   â”œâ”€â”€ data_extraction.py
â”‚   â””â”€â”€ database_queries.py
â”œâ”€â”€ tests/                     # Comprehensive test suite (MUST UPDATE)
â”‚   â”œâ”€â”€ test_business_insight_worksheet.py
â”‚   â”œâ”€â”€ test_yearly_comparison_worksheet.py
â”‚   â”œâ”€â”€ test_time_segment_worksheet.py
â”‚   â”œâ”€â”€ test_extract_all.py
â”‚   â”œâ”€â”€ test_validation_against_actual_data.py
â”‚   â””â”€â”€ run_comprehensive_tests.py
â”œâ”€â”€ utils/                     # Shared utilities
â”‚   â””â”€â”€ database.py
â”œâ”€â”€ haidilao-database-querys/  # Database schema and migrations
â”‚   â”œâ”€â”€ reset-db.sql           # Complete database reset with new schema
â”‚   â”œâ”€â”€ alter_dish_structure.sql # Safe migration script
â”‚   â””â”€â”€ [other SQL files]
â”œâ”€â”€ output/                    # Generated reports
â”œâ”€â”€ README.md                  # Main documentation (MUST UPDATE)
â”œâ”€â”€ requirements.txt          # Python dependencies
â””â”€â”€ .cursorrules              # This file
```

## ğŸ”§ CODING STANDARDS

### Python Code Style

- Use Python 3.8+ features
- Follow PEP 8 with 100-character line limit
- Use type hints for all function parameters and returns
- Use docstrings for all classes and functions
- Prefer f-strings over .format() or % formatting
- Use pathlib.Path for file operations
- Handle errors gracefully with specific exception types

### File Organization

- One class per file when possible
- Group related functions logically
- Import order: standard library, third-party, local imports
- Use relative imports within the project

### Database Integration

- Always use parameterized queries to prevent SQL injection
- Use connection pooling and proper resource cleanup
- Support both test and production database environments
- Implement transaction safety with rollback on errors
- **Database Schema Evolution**:
  - Dishes now include `size` column for proper uniqueness `(full_code, size)`
  - Simplified dish_material table structure (removed unit/conversion_factor)
  - Use `alter_dish_structure.sql` for safe migrations without data loss
  - Always create migration scripts for schema changes
- **Price History**: Implement activation logic (mark previous prices as inactive)
- Use `DatabaseManager` with `DatabaseConfig(is_test=True)` for test operations
- **Data Extraction Patterns**: Create separate scripts for dishes, materials, relationships, and price history

### Excel Processing

- Use pandas + openpyxl for Excel operations
- Validate data before processing
- Handle missing/null values gracefully
- Support Chinese store names and time segments properly
- **CRITICAL**: When reading dish codes from Excel, remove `.0` suffix from float conversions
- **CRITICAL**: When reading material numbers from Excel, ALWAYS use `dtype={'ç‰©æ–™': str}` to prevent float64 conversion that causes precision loss and makes different material numbers appear identical
- Use Unicode escape sequences for Chinese column names in code for reliability
- Always test data filtering step-by-step when debugging extraction issues
- **Multi-Source Data Handling**:
  - Sales reports: Extract dishes with sizes and price history
  - Inventory files: Extract materials and dish-material relationships
  - Handle different Excel structures and worksheet names
  - Implement proper data validation before database insertion
- **Material Number Handling**: Remove leading zeros with `material_number.lstrip('0')` but preserve as string throughout processing
- **Representative Product Selection**: When multiple products share same material number, select product with highest total contribution (price Ã— quantity) per material per store per month
- **Target Date Parameter Passing**: Ensure --target-date parameter is properly passed through all automation workflows to prevent CURRENT_DATE usage

### Excel Reading Patterns - CRITICAL LESSONS LEARNED

**MAJOR BUG DISCOVERED**: Pandas default Excel reading converts material numbers to float64, causing precision loss:
- Material numbers like `'000000000001500680'` and `'000000000001500681'` both become `1500680.0`
- This makes different materials appear identical, causing incorrect price calculations
- **SOLUTION**: Always specify `dtype={'ç‰©æ–™': str}` when reading Excel files with material numbers

**Correct Excel Reading Pattern**:
```python
# CORRECT - Preserves material number precision
dtype_spec = {'ç‰©æ–™': str}
df = pd.read_excel(file_path, engine='openpyxl', dtype=dtype_spec)

# INCORRECT - Causes precision loss
df = pd.read_excel(file_path, engine='openpyxl')  # Default converts to float64
```

**Material Number Processing**:
```python
# Clean material number - remove leading zeros but keep as string
material_number = str(material_number).strip().lstrip('0')
```

**Representative Product Selection Logic**:
When multiple products share the same material number:
1. Group by material_name (product description)
2. Calculate total contribution (price Ã— quantity) for each product group
3. Select the product group with highest total contribution
4. Use weighted average price for that selected product group
5. Store only ONE record per (material_number, store_id, effective_date)

## ğŸ§ª TESTING REQUIREMENTS

### Test Coverage Standards

- Maintain 100% test coverage for core modules
- Each new feature MUST include comprehensive tests
- Test categories required:
  - Initialization tests
  - Success path tests
  - Error handling tests
  - Edge case tests
  - Integration tests
  - Data validation tests

### Test File Naming

- Test files: `test_{module_name}.py`
- Test classes: `Test{ClassName}`
- Test methods: `test_{functionality}_{scenario}`

### Current Working Test Modules (62 tests total)

- `test_business_insight_worksheet.py` (9 tests)
- `test_yearly_comparison_worksheet.py` (21 tests)
- `test_time_segment_worksheet.py` (9 tests)
- `test_extract_all.py` (18 tests)
- `test_validation_against_actual_data.py` (5 tests)

### Implemented Features

- **Database Structure Overhaul**

  - Added `size` column to dish table for proper dish uniqueness
  - Simplified dish_material table (removed `unit` and `conversion_factor`)
  - Created `alter_dish_structure.sql` for safe database migrations
  - Updated `reset-db.sql` with new schema

- **Dish Extraction System** (`scripts/extract-dishes.py`)

  - Extracts dishes with size information from sales reports
  - Uses `(full_code, size)` for uniqueness instead of just `full_code`
  - Handles Unicode column names and float conversion issues
  - Successfully extracts 463+ unique dishes with proper sizing

- **Material Extraction System** (`scripts/extract-materials.py`)

  - Extracts materials from export.XLSX files
  - Integrated with automation menu

- **Dish-Material Relationship System** (`scripts/extract-dish-materials.py`)

  - Maps dishes to materials with standard quantities
  - Reads from inventory calculation worksheets
  - Handles complex Excel structures with proper error handling

- **Dish Price History Extraction** (`scripts/extract_dish_price_history.py`)
  - Extracts price history from monthly dish sales reports
  - Handles dish code float conversion (.0 suffix removal)
  - Supports store name to ID mapping
  - Implements price history activation logic
  - Successfully processes 2,340+ price records
  - Integrated in automation menu as option 9

- **Store-Specific Material Price System** (`scripts/extract_material_prices_by_store.py`)
  - **Database Schema Migration**: Changed `material_price_history` from `district_id` to `store_id`
  - Extracts material prices from Excel files on a store-by-store basis
  - Auto-detects store ID from filename or manual specification
  - Handles price history activation (deactivates old prices)
  - Updated all related queries to use store-specific pricing
  - Migration script: `migrate_material_price_history_to_store.sql`
  - Integrated in automation menu as option 'p'

- **Batch Material Price Extraction System** (`scripts/extract_material_detail_prices_by_store_batch.py`)
  - **CRITICAL EXCEL READING FIX**: Uses `dtype={'ç‰©æ–™': str}` to prevent float64 conversion that caused material number precision loss
  - Processes all stores in parallel for efficient material price extraction
  - Implements representative product selection logic (highest total contribution per material)
  - Supports proper target date parameter passing to prevent CURRENT_DATE usage
  - Handles leading zero removal from material numbers while preserving as strings
  - Calculates weighted averages correctly per individual material number
  - Integrated with monthly automation workflow

- **Enhanced Automation Menu Structure** (`scripts/automation-menu.py`)
  - Organized into logical sections with emoji indicators
  - ğŸ“Š Data Extraction: dishes (d), materials (m), relationships (q), price history (9)
  - ğŸ—„ï¸ Database Operations: reset (r), view data (v), run tests (t)
  - ğŸ“‹ Report Generation: database reports (g), custom workflows
  - Clear navigation with section headers and consistent command patterns

## ğŸ“‹ MANDATORY UPDATE REQUIREMENTS

### When Adding New Features

ALWAYS update these files in this order:

1. **Core Implementation** (lib/ modules)

   - Implement the feature with proper error handling
   - Add type hints and docstrings
   - Follow existing patterns

2. **Tests** (tests/ directory)

   - Add comprehensive test coverage
   - Test all success and failure scenarios
   - Update `run_comprehensive_tests.py` if needed
   - Ensure all tests pass: `python3 -m unittest tests.test_* -v`

3. **Automation Menu & GUI** (scripts/automation-menu.py & scripts/automation-gui.py)

   - Add menu option for new feature in CLI
   - Add corresponding GUI tab/button if needed
   - Update help documentation in both interfaces
   - Add to appropriate menu section
   - Test command integration in both CLI and GUI

4. **README.md**

   - Update feature list
   - Add usage examples
   - Update test count and coverage info
   - Document any new dependencies

5. **Requirements.txt** (if applicable)
   - Add new Python dependencies
   - Update version constraints if needed

### When Modifying Existing Features

1. **Update tests first** to reflect new expected behavior
2. **Modify implementation** to pass tests
3. **Update menu** if command interface changes
4. **Update README** if user-facing behavior changes
5. **Update requirements.txt** if new dependencies added

## ğŸ¯ FEATURE IMPLEMENTATION PATTERNS

### New Worksheet Generator

```python
class NewWorksheetGenerator:
    """Generator for new worksheet type."""

    def __init__(self, data_provider: ReportDataProvider):
        self.data_provider = data_provider
        self.logger = logging.getLogger(__name__)

    def generate_worksheet(self, workbook, target_date: str) -> None:
        """Generate worksheet with proper formatting."""
        # Implementation with error handling
        pass
```

### New Test Module Template

```python
class TestNewWorksheetGenerator(unittest.TestCase):
    """Comprehensive tests for NewWorksheetGenerator."""

    def setUp(self):
        """Set up test fixtures."""
        pass

    def test_generator_initialization(self):
        """Test generator initialization."""
        pass

    def test_worksheet_creation(self):
        """Test worksheet creation."""
        pass

    # Add 5-10 more test methods covering all scenarios
```

### Menu Integration Pattern

```python
# In automation-menu.py, add to appropriate section:
new_options = [
    ("n", "New Feature Description", "new_feature"),
]
self.print_menu_section("ğŸ“Š SECTION NAME", new_options)

# Add handler:
elif choice == 'n':
    self.run_new_feature()

def run_new_feature(self):
    """Handle new feature execution."""
    command = 'python3 scripts/new_feature.py'
    self.run_command(command, "New Feature Description")
```

### Current Menu Structure

```
ğŸ² HAIDILAO PAPERWORK AUTOMATION SYSTEM
â”œâ”€â”€ ğŸ“Š DATA EXTRACTION
â”‚   â”œâ”€â”€ d - Extract Dishes (with sizes)
â”‚   â”œâ”€â”€ m - Extract Materials  
â”‚   â”œâ”€â”€ q - Extract Dish-Material Relationships
â”‚   â”œâ”€â”€ 9 - Extract Dish Price History
â”‚   â””â”€â”€ p - Extract Material Prices by Store
â”œâ”€â”€ ğŸ—„ï¸ DATABASE OPERATIONS
â”‚   â”œâ”€â”€ r - Reset Database
â”‚   â”œâ”€â”€ v - View Database Data
â”‚   â””â”€â”€ t - Run Tests
â”œâ”€â”€ ğŸ“‹ REPORT GENERATION
â”‚   â”œâ”€â”€ g - Generate Database Report
â”‚   â””â”€â”€ a - Complete Automation Workflow
â””â”€â”€ ğŸ”§ SYSTEM OPERATIONS
    â”œâ”€â”€ h - Help
    â”œâ”€â”€ Store 6 Conversion (Legacy - Disabled)
    â””â”€â”€ x - Exit
```

## ğŸ“Š REPORT GENERATION STANDARDS

### Excel Formatting

- Use professional styling with borders and colors
- Set appropriate column widths (15-20 for text, 12-15 for numbers)
- Merge cells for headers appropriately
- Use conditional formatting for data highlighting
- Support Chinese characters properly

### Data Validation

- Validate all input data before processing
- Ensure numeric calculations are accurate
- Implement percentage formatting for rates

### Error Handling

- Log all errors with context
- Provide user-friendly error messages
- Fail gracefully without corrupting output
- Support partial data scenarios

## ğŸ—„ï¸ DATABASE BEST PRACTICES

### Connection Management

- Use environment variables for credentials
- Support both test and production databases
- Implement connection retry logic
- Close connections properly

### Local Database Configuration

**Production Database Connection Details:**
```bash
# Local PostgreSQL connection for production use
Host: localhost
Username: hongming
Password: 8894
Database: haidilao-paperwork
Port: 5432 (default)

# Example connection commands:
psql -h localhost -U hongming -d haidilao-paperwork

# Migration example:
psql -h localhost -U hongming -d haidilao-paperwork -f haidilao-database-querys/migrate_normalize_exchange_rates.sql

# MIGRATION STATUS: âœ… Exchange rate normalization completed (2025-01-01)
# - month_static_data table created with 12 exchange rate records
# - monthly_CAD_USD_rate column removed from store_monthly_target
# - Database structure normalized for better performance and maintainability
```

**Test Database Configuration:**
- Use `DatabaseConfig(is_test=True)` for test operations
- Separate test database recommended for development
- Always backup before running migrations on production database

### Query Optimization

- Use single optimized queries when possible
- Implement proper indexing assumptions
- Cache frequently accessed data
- Use transactions for data consistency

## ğŸ“± CLI/Menu Design Principles

### User Experience

- Clear, emoji-enhanced menus organized by functional areas
- Confirmation prompts for destructive actions
- Progress indicators for long operations
- Helpful error messages with suggestions
- Logical grouping: Data Extraction â†’ Database Operations â†’ Report Generation
- Consistent command patterns within each section

### Command Structure

- Consistent command naming
- Support for help flags (--help)
- Reasonable defaults
- Clear success/failure feedback

## ğŸ” CODE REVIEW CHECKLIST

Before any commit, ensure:

- [ ] All tests pass (100% success rate required)
- [ ] New features have comprehensive test coverage
- [ ] Automation menu updated if needed
- [ ] README.md reflects current capabilities
- [ ] Error handling implemented
- [ ] Type hints added
- [ ] Docstrings present
- [ ] No hardcoded values (use config/env vars)
- [ ] Chinese text handling works correctly
- [ ] Database connections cleaned up properly
- [ ] **Excel float conversion**: Dish codes stripped of `.0` suffix
- [ ] **CRITICAL: Material number reading**: Use `dtype={'ç‰©æ–™': str}` in pd.read_excel() to prevent float64 conversion precision loss
- [ ] **Target date parameter**: Ensure --target-date parameter is properly passed through automation workflows
- [ ] **Representative product selection**: Verify logic picks product with highest total contribution per material
- [ ] **Date handling**: Check for CURRENT_DATE usage and replace with target_date where appropriate
- [ ] **Debugging approach**: Create step-by-step diagnostic scripts for complex issues
- [ ] **Unicode handling**: Chinese column names use escape sequences for reliability

## ğŸš€ DEPLOYMENT STANDARDS

### Environment Setup

- Python 3.8+ required
- All dependencies in requirements.txt
- Environment variables documented in README
- Database schema files present

### Testing Before Release

1. Run comprehensive test suite: `python3 -m unittest tests.test_* -v`
2. Test automation menu: `python3 scripts/automation-menu.py`
3. Verify report generation with test data
4. Check database connections
5. Validate all help documentation

## ğŸ¨ EMOJI USAGE STANDARDS

Use consistent emojis for:

- ğŸ² Project branding
- âœ… Success states
- âŒ Error states
- âš ï¸ Warnings
- ğŸ”„ Processing
- ğŸ“Š Data/Reports
- ğŸ§ª Testing
- ğŸ—„ï¸ Database
- ğŸ“ Files
- ğŸ¯ Goals/Targets
- ğŸš€ Deployment/Launch

## ğŸ“ SUPPORT AND DOCUMENTATION

### Internal Documentation

- Update docstrings for all public methods
- Add inline comments for complex logic
- Document data formats and expected inputs
- Maintain database schema documentation

### User Documentation

- Keep README.md current with features
- Document all CLI options
- Provide troubleshooting guide
- Include example usage

## ğŸ”§ MAINTENANCE REQUIREMENTS

### Regular Updates

- Test with new data monthly
- Update dependencies quarterly
- Review and optimize database queries
- Monitor test execution time

### Performance Standards

- Test suite execution: < 5 seconds
- Report generation: < 30 seconds
- Menu response time: < 1 second
- Database queries: < 10 seconds

## ğŸ¨ GUI DEVELOPMENT STANDARDS

### Tkinter Best Practices

- Use ttk widgets for modern appearance
- Implement consistent styling with style.configure()
- Follow Haidilao color scheme (red primary: #dc2626)
- Use threading for long-running operations
- Implement proper error handling with messagebox
- Provide real-time feedback via console output

### GUI Architecture

- Single main window with tabbed interface
- Separate concerns: processing, reports, testing, database, settings
- Background thread execution for commands
- Live output console with command feedback
- Status bar with progress indication
- File browser integration for Excel selection

### User Experience Standards

- Clear visual hierarchy with proper spacing
- Descriptive labels and tooltips
- Confirmation dialogs for destructive actions
- Keyboard shortcuts where appropriate
- Remember user preferences and last used values
- Visual feedback for all operations

### GUI Update Requirements

When adding new features to GUI:

1. **Update automation-gui.py**

   - Add new tab if needed
   - Integrate with existing command structure
   - Follow established styling patterns
   - Add proper error handling

2. **Update automation-menu.py** (maintain CLI compatibility)

   - Keep feature parity between GUI and CLI
   - Ensure same commands work in both interfaces

3. **Test both interfaces**

   - Verify GUI functionality
   - Ensure CLI menu still works
   - Test cross-platform compatibility

4. **Update README.md**
   - Document new GUI features
   - Update usage examples
   - Maintain installation instructions

## ğŸ› ï¸ TROUBLESHOOTING PATTERNS

### Excel Data Extraction Issues

When extraction scripts produce no results:

1. **Check file structure**: Verify sheet names and column existence
2. **Test data filtering**: Create diagnostic scripts to check each filtering step
3. **Verify data types**: Look for float conversion issues (especially `.0` suffixes)
4. **Database lookup**: Test lookup functions separately with sample data
5. **Unicode handling**: Use escape sequences for Chinese column names

### Common Issues and Solutions

- **Dish codes not found**: Remove `.0` suffix from pandas float conversions
- **No database insertions**: Check transaction handling and error logging
- **Large file hanging**: Use `nrows` parameter for testing with sample data
- **Chinese characters**: Use Unicode escape sequences in column names
- **Schema migration issues**: Use `alter_dish_structure.sql` for safe updates
- **Dish uniqueness conflicts**: Ensure `(full_code, size)` combination is used
- **Material relationship failures**: Verify both dish and material exist before creating relationships
- **Data extraction debugging**: Create step-by-step diagnostic scripts to isolate issues
- **Store 6 conversion**: Legacy conversion logic kept for reference but removed from daily workflow
- **CRITICAL: Material number float64 conversion bug**: When different material numbers (1500680, 1500681, etc.) all appear as same value (1500680.0), use `dtype={'ç‰©æ–™': str}` in pd.read_excel() to prevent pandas from converting string material numbers to float64
- **Effective date shows system date instead of target date**: Check for CURRENT_DATE usage in SQL and replace with proper target_date parameter passing through automation workflows
- **Representative product selection errors**: When material prices are unexpectedly high/low, verify that representative product selection is working correctly - should pick product with highest total contribution (price Ã— quantity) per material
- **Material price weighted average calculation**: Ensure weighted averages are calculated per individual material number, not across all products sharing a material number
- **Target date parameter not passed**: When automation scripts show wrong dates, verify --target-date parameter is added to script and properly passed through complete_monthly_automation_new.py
- **Gross margin report price history fixes**: Fixed price history logic in `get_gross_margin_dish_price_data` and `get_gross_margin_material_cost_data` to properly handle missing historical price data. Key improvements: 1) For "å»å¹´åŒæœŸå•ä»·", changed from per-store lookup to dish-level lookup to find the most recent historical price across all stores (e.g., dish 1060062 now correctly shows $20.95 from 2024-05-31 instead of falling back to current $24.95). 2) For "ä¸ŠæœŸå•ä»·", uses fallback to current price when no previous period data exists. 3) Used separate CTEs instead of UNION ALL to avoid PostgreSQL limitations.

---

**ğŸ² Remember: This is a production system for Haidilao restaurant operations.**
**Every change must maintain reliability and data accuracy.**
**When in doubt, add more tests and update documentation.**
